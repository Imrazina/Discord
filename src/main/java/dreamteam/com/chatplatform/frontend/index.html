<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket Chat</h2>
<input type="text" id="message" placeholder="Enter message">
<button id="sendBtn">Send</button> <!-- –î–æ–±–∞–≤–∏–ª id -->
<ul id="messages"></ul>
<a href="register.html"> registart</a>

<script>
    console.log("üì° Token from localStorage:", localStorage.getItem("token"));

    let stompClient = null; // üëà –î–µ–ª–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π

    function connectWebSocket() {
        const socket = new SockJS('http://localhost:8082/ws');
        stompClient = Stomp.over(socket); // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∏–µ–Ω—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

        const token = localStorage.getItem("token");

        stompClient.connect(
            { Authorization: "Bearer " + token },
            function (frame) {
                console.log("‚úÖ Connected to WebSocket!");
            },
            function (error) {
                console.error("‚ùå WebSocket Error: ", error);
            }
        );
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) { // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ WebSocket
            console.error("‚ùå WebSocket is not connected yet!");
            return;
        }

        let messageContent = document.getElementById("message").value;

        stompClient.send("/app/chat",
            { "Authorization": "Bearer " + localStorage.getItem("token") }, // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            JSON.stringify({ content: messageContent })
        );
    }

    document.addEventListener("DOMContentLoaded", function () {
        if (localStorage.getItem("token")) {
            connectWebSocket();
        }
    });

    document.getElementById("sendBtn").addEventListener("click", sendMessage); // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
</script>

</body>
</html>
